/*! basetools - 2014-12-23
     * author:zhaoqiang
     * Includes: form2json,
     * 页面通用公共方法js，所有通用方法集中写在这里 */

define(["jquery"],function($){function upload(e,t){function n(e){var n=JSON.parse(e.target.response);$("#"+t).summernote("editor.insertImage","http://of6k5lmot.bkt.clouddn.com/"+n.key),$(".note-alarm").html("上传成功,请等待加载"),setTimeout(function(){$(".note-alarm").remove()},3e3)}function r(e){$(".note-alarm").html("上传失败"),setTimeout(function(){$(".note-alarm").remove()},3e3)}function a(e){}var i=new XMLHttpRequest,o=!1;try{o=e.name}catch(e){o=!1}o||$(".note-alarm").remove();var s=new FormData;s.append("file",e),$.restAjax({url:$.apiPath+moduleName.resource+$.apijoin+"storage"+$.apijoin+"token"+$.apijoin+"common",type:"get",async:!1,success:function(e){"200"==e.status&&(s.append("token",e.result),s.append("key",$.dropguid()+o.substr(o.lastIndexOf("."))))}}),i.addEventListener("load",n,!1),i.addEventListener("error",r,!1),i.addEventListener("abort",a,!1),i.open("POST","http://upload.qiniu.com",!0),headers={Accept:"application/json","Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest"};for(headerName in headers)headerValue=headers[headerName],i.setRequestHeader(headerName,headerValue);i.send(s)}function loadScript(e,t){if(jsArray[e])t&&t();else{jsArray[e]=!0;var n=document.getElementsByTagName("body")[0],r=document.createElement("script");r.type="text/javascript",r.src=e,r.onload=t,n.appendChild(r)}}!function(e){e.fn.extend({checkboxCtrl:function(t){return this.each(function(){var n=e(this);n.bind("click",function(){var r=n.attr("group");if(n.is(":checkbox")){var a=n.is(":checked")?"all":"none";r&&e.checkbox.select(r,a,t)}else r&&e.checkbox.select(r,n.attr("selectType")||"all",t);e(t).find(":checkbox[name='"+r+"']").click(function(){var t=e(":checkbox[name='"+r+"']");n.attr("checked",t.length==t.filter(":checked").length)})})})}}),e.checkbox={selectAll:function(e,t){this.select(e,"all",t)},unSelectAll:function(e,t){this.select(e,"none",t)},selectInvert:function(e,t){this.select(e,"invert",t)},select:function(t,n,r){switch($parent=e(r||document),$checkboxLi=$parent.find(":checkbox[name='"+t+"']"),n){case"invert":$checkboxLi.each(function(){$checkbox=e(this),$checkbox.prop("checked",!$checkbox.is(":checked"))});break;case"none":$checkboxLi.prop("checked",!1);break;default:$checkboxLi.prop("checked",!0)}}}}(jQuery),function(e){e.icheck={init:function(){var t=this;t._checkbox="checkbox",t._radio="radio",t._disabled="disabled",t._enable="enable",t._checked="checked",t._hover="hover",t._arrtype=[t._checkbox,t._radio],t._mobile=/ipad|iphone|ipod|android|blackberry|windows phone|opera mini|silk/i.test(navigator.userAgent),e.each(t._arrtype,function(e,n){t.click(n),t._mobile||(t.mouseover(n),t.mouseout(n))})},click:function(t){var n=this;t="."+t,e(document).on("click",t,function(){var r=e(this),a=r.find("ins");if(!a.hasClass(n._disabled)&&!a.hasClass(n._enable))if(!/radio/gi.test(t)&&a.hasClass(n._checked))a.removeClass(n._checked).addClass(n._hover);else{if(/radio/gi.test(t)){var i=r.attr("name");e(t+"[name="+i+"]").find("ins").removeClass(n._checked)}e(t).find("ins").removeClass(n._hover),a.addClass(n._checked)}})},mouseover:function(t){var n=this;t="."+t,e(document).on("mouseover",t,function(){var t=e(this),r=t.find("ins");r.hasClass(n._disabled)||r.hasClass(n._enable)||r.hasClass(n._checked)?t.css("cursor","default"):(r.addClass(n._hover),t.css("cursor","pointer"))})},mouseout:function(t){var n=this;t="."+t,e(document).on("mouseout",t,function(){e(t).find("ins").removeClass(n._hover)})}},e.icheck.init()}(jQuery);var paramString2obj=function(serializedParams){function evalThem(str){var attributeName=str.split("=")[0],attributeValue=str.split("=")[1];if(null!=attributeValue){for(var array=attributeName.split("."),i=1;i<array.length;i++){var tmpArray=Array();tmpArray.push("obj");for(var j=0;j<i;j++)tmpArray.push(array[j]);var evalString=tmpArray.join(".");eval(evalString)||eval(evalString+"={};")}eval("obj."+attributeName+"='"+attributeValue+"';")}}for(var obj={},properties=serializedParams.split("&"),i=0;i<properties.length;i++)evalThem(properties[i]);return obj};$.fn.form2json=function(){var e=this.serializeForm(),t=paramString2obj(decodeURIComponent(e));return JSON.stringify(t)},$.fn.doesExist=function(){return jQuery(this).length>0};var backTip=function(e,t){var n="fa fa-check fa-2x fadeInRight animated",r="#739E73";"N"==t&&(n="fa fa-times fa-2x fadeInRight animated",r="#C46A69"),$.smallBox({title:"提示信息",content:"<i class='fa fa-clock-o'></i> <i>"+e.message+"</i>",color:r,iconSmall:n,timeout:3e3})};jQuery.restAjax=function(e){$("#loading").size()<1&&($("body").append('<div id="loading"></div>'),$("#loading").css({position:"fixed",_position:"absolute",top:"50%",left:"50%",width:"124px",height:"124px",overflow:"hidden",background:"url(./includes/lib/smartadmin/img/loading.gif) no-repeat","z-index":"7",margin:"-62px 0 0 -62px",display:"none"})),$("#loading").show();var t={url:"",data:{},type:"post",base:"",dataType:"json",async:!0,beforeSend:function(e){e.setRequestHeader("token",token),e.setRequestHeader("Content-Type","application/json;charset=utf-8")},crossDomain:!1},n=function(e){var n=$.extend({},t,e);return n};if(e){var r=n(e);r.cache||"GET"!=r.type.toUpperCase()?r.url=r.base+r.url:r.url=r.base+(r.url.indexOf("?")>0?r.url+"&expireToken="+Math.random():r.url+"?expireToken="+Math.random()),$.ajax(r).done(function(e,t,n){n.getResponseHeader("refreshToken")&&(token=n.getResponseHeader("refreshToken")),r.success&&e&&"200"!=e.status&&backTip(e,"N")}).fail(function(e){console.log("error"),r.fail?r.fail(e):alert("数据传输失败，请重试！")}).always(function(e){$("#loading").fadeOut()})}};var dateFormat=function(e,t){"string"==typeof t&&(t=parseInt(t));var n=t?new Date(t):new Date,r=function(e,t){return(e+="").length<t?new Array(++t-e.length).join("0")+e:e},a=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],i={1:"st",2:"nd",3:"rd",21:"st",22:"nd",23:"rd",31:"st"},o=["","January","February","March","April","May","June","July","August","September","October","November","December"],s={d:function(){return r(s.j(),2)},D:function(){return s.l().substr(0,3)},j:function(){return n.getDate()},l:function(){return a[s.w()]},N:function(){return s.w()+1},S:function(){return i[s.j()]?i[s.j()]:"th"},w:function(){return n.getDay()},z:function(){return(n-new Date(n.getFullYear()+"/1/1"))/864e5>>0},W:function(){var e,t=s.z(),r=364+s.L()-t,a=(new Date(n.getFullYear()+"/1/1").getDay()||7)-1;return r<=2&&(n.getDay()||7)-1<=2-r?1:t<=2&&a>=4&&t>=6-a?(e=new Date(n.getFullYear()-1+"/12/31"),date("W",Math.round(e.getTime()/1e3))):1+(a<=3?(t+a)/7:(t-(7-a))/7)>>0},F:function(){return o[s.n()]},m:function(){return r(s.n(),2)},M:function(){return s.F().substr(0,3)},n:function(){return n.getMonth()+1},t:function(){var e;return 2==(e=n.getMonth()+1)?28+s.L():1&e&&e<8||!(1&e)&&e>7?31:30},L:function(){var e=s.Y();return 3&e||!(e%100)&&e%400?0:1},Y:function(){return n.getFullYear()},y:function(){return(n.getFullYear()+"").slice(2)},a:function(){return n.getHours()>11?"pm":"am"},A:function(){return s.a().toUpperCase()},B:function(){var e=60*(n.getTimezoneOffset()+60),t=3600*n.getHours()+60*n.getMinutes()+n.getSeconds()+e,r=Math.floor(t/86.4);return r>1e3&&(r-=1e3),r<0&&(r+=1e3),1==String(r).length&&(r="00"+r),2==String(r).length&&(r="0"+r),r},g:function(){return n.getHours()%12||12},G:function(){return n.getHours()},h:function(){return r(s.g(),2)},H:function(){return r(n.getHours(),2)},i:function(){return r(n.getMinutes(),2)},s:function(){return r(n.getSeconds(),2)},O:function(){var e=r(Math.abs(n.getTimezoneOffset()/60*100),4);return e=n.getTimezoneOffset()>0?"-"+e:"+"+e},P:function(){var e=s.O();return e.substr(0,3)+":"+e.substr(3,2)},c:function(){return s.Y()+"-"+s.m()+"-"+s.d()+"T"+s.h()+":"+s.i()+":"+s.s()+s.P()},U:function(){return Math.round(n.getTime()/1e3)}};return e.replace(/[\\]?([a-zA-Z])/g,function(e,t){return e!=t?ret=t:s[t]?ret=s[t]():ret=t,ret})},jsonToStr=function(e){switch(typeof e){case"string":return'"'+e.replace(/(["\\])/g,"\\$1")+'"';case"array":return"["+e.map(jsonToStr).join(",")+"]";case"object":if("[object Array]"===Object.prototype.toString.call(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(jsonToStr(e[r]));return"["+t.join(",")+"]"}if(null==e)return"null";var a=[];for(var i in e)a.push(jsonToStr(i)+":"+jsonToStr(e[i]));return"{"+a.join(",")+"}";case"number":return e;case!1:return e;case"boolean":return e}},strToJson=function(str){return null!=str&&"undefined"!=typeof str&&(str=str.replace(/\r\n/g,"\\n")),eval("("+str+")")},sendFile=function(e,t,n){$(".note-toolbar.btn-toolbar").append(" 正在上传图片 ");var r=!1;try{r=e.name}catch(e){r=!1}r||$(".note-alarm").remove();var a=new FormData;"http://upload.qiniu.com"==n&&$.restAjax({url:$.apiPath+moduleName.resource+$.apijoin+"storage"+$.apijoin+"token"+$.apijoin+"common",type:"get",async:!1,success:function(e){"200"==e.status&&(a.append("token",e.result),a.append("key","summer_"+$.dropguid()+r.substr(r.lastIndexOf("."))))}}),a.append("file",e),$.ajax({data:a,type:"POST",url:n,cache:!1,contentType:!1,processData:!1,beforeSend:function(e){e.setRequestHeader("token",token),e.setRequestHeader("appKey","LexingInternalApp")},success:function(e){$("#"+t).summernote("editor.insertImage","http://of6k5lmot.bkt.clouddn.com/"+e.key),$(".note-alarm").html("上传成功,请等待加载"),setTimeout(function(){$(".note-alarm").remove()},3e3)},error:function(){$(".note-alarm").html("上传失败"),setTimeout(function(){$(".note-alarm").remove()},3e3)}})},summerNoteEditor=function(e,t,n){requirejs(["summernote","summernote-zh-CN"],function(r,a){var i={height:300,lang:"zh-CN",disableDragAndDrop:!0,dialogsInBody:!0,shortcuts:!0,toolbar:[["style",["bold","italic","underline","clear"]],["font",["strikethrough","superscript","subscript"]],["fontsize",["fontsize"]],["fontname",["fontname"]],["color",["color"]],["table",["table"]],["para",["ul","ol","paragraph"]],["fullscreen",["fullscreen"]],["codeview",["codeview"]],["height",["height"]],["picture",["picture"]],["remove",["removeMedia"]]],callbacks:{onBlur:function(){},onImageUpload:function(t,n,r){upload(t[0],e)}}},o=$.extend(i.callbacks,n.callbacks);i=$.extend(i,n),i.callbacks=o,e?$("#"+e).summernote(i):$("."+t).summernote(i)})},fileInpputInit=function(e,t){requirejs(["fileinput","fileinput_locale_zh"],function(n,r){var a={language:"zh",showUpload:!0,showCaption:!0,showPreview:!0,showCancel:!1,showRemove:!1,autoReplace:!0,browseOnZoneClick:!0,maxFileCount:100,uploadUrl:$.apiPath+"apis/1/storage/common/common",browseClass:"btn btn-primary btn-sm",removeClass:"btn btn-default btn-sm",uploadClass:"btn btn-default btn-sm",allowedFileExtensions:["jpg","png","gif","pdf"]};a=$.extend(a,t),$("#"+e).fileinput(a),t&&t.edit&&($("#"+e).closest(".btn-file").addClass("disabled"),$("#"+e).closest(".file-input").find(".file-caption").append(t.fileSize?"<div class='file-caption-size'>("+t.fileSize+")</div>":""),$("#"+e).closest(".file-input").find(".file-caption .file-caption-name").attr("title",t.msgSelected+(t.fileSize?"("+t.fileSize+")":"")))})},dropZoneInit=function(e,t){requirejs(["dropzone"],function(n){n.autoDiscover=!1;var r={url:"http://upload.qiniu.com",method:"post",headers:{token:token},paramName:"file",addRemoveLinks:!0,dictInvalidInputType:"X",maxFiles:6,maxFilesize:2,acceptedFiles:".jpg,.png,.jpeg",dictCancelUpload:"移除",dictRemoveFile:"移除",uploadMultiple:!1,dictFileTooBig:"文件不能大于2M",dictInvalidFileType:"文件类型不正确",dictRemoveFileConfirmation:"是否确定删除",fileWidthCompare:!1,init:function(){var e=this;if(t.initDrop=this,$("#"+t.urlId).val()){var n=$("#"+t.urlId).val().split(",");for(var r in n){var a=n[r].substring(n[r].lastIndexOf("/")+1),i={name:"",size:12345,fileName:a,status:"success",accepted:!0,upload:{bytesSent:1}};e.files.push(i),e.emit("addedfile",i),e.emit("thumbnail",i,n[r]),e.emit("complete",i),e.emit("selectedfiles",i);var o={code:"200",result:n[r],editInit:!0};e.emit("success",i,o,"")}}},maxfilesexceeded:function(e){var t;return null!=(t=e.previewElement)&&t.parentNode.removeChild(e.previewElement),this._updateMaxFilesReachedClass()},removedfile:function(n){if("success"==n.status)$.restAjax({url:$.apiPath+"apis@1@storage@common?fileName="+n.fileName,type:"delete",success:function(r){if("200"==r.status){for(var a,i=$("#"+t.urlId).val().split(","),o=0;o<i.length;o++){var s=i[o];if(s&&s.substring(s.lastIndexOf("/")+1)==n.fileName){i.splice(o,1);break}}null!=(a=n.previewElement)&&a.parentNode.removeChild(n.previewElement),$("#"+t.urlId).val(i.join(",")),$("#"+e+" .dz-message,#"+e).css("cursor","pointer").removeAttr("disabled"),$("input[type='file']").removeAttr("disabled")}}});else{var r;null!=(r=n.previewElement)&&r.parentNode.removeChild(n.previewElement)}},success:function(e,n){if("200"==n.code||n.key){var r=t.buket+n.key;return n.editInit||($("#"+t.urlId).val($("#"+t.urlId).val()?$("#"+t.urlId).val()+","+r:r),e.fileName=n.key),e.previewElement.classList.add("dz-success")}return e.previewElement.classList.add("dz-error")},accept:function(e,t){return console.log(e),t()},complete:function(e){}};r=$.extend(r,t),$("#"+e).dropzone(r)})},dictDataInit=function(e,t){$.restAjax({url:$.apiPath+"apis/1/common/standardChoices/"+t+"/values",type:"get",async:!1,cache:!1,beforeSend:function(e){e.setRequestHeader("token",token)},success:function(t){for(var n=t.result,r="<option value=''>请选择</option>",a=0;a<n.length;a++)r+="<option value="+n[a].dictDataKey+" text="+n[a].dictDataValue+">"+n[a].dictDataValue+"</option>";$("#"+e).append(r)}})},jsArray={};$.fn.qdata=function(){var e={},t=$(this).attr("data");if(t)for(var n=t.split(";"),r=0;r<n.length;r++)if(n[r]){var a=n[r].split(":");e[a[0]]=a[1]}return e};var lx={};return lx.tree={},lx.tree.options={url:"",height:"600px",open:!0,edit:!1,checkbox:!1,showurl:!0},$.fn.bstree=function(e){var t=$.extend({},lx.tree.options);e&&("string"==typeof e?t.url=e:$.extend(t,e));var n="加载失败！",r=$(this);$.restAjax({url:t.url+"/tree",success:function(e){if(e&&e.object){var a=e.object,i='<div class="panel panel-info"><div class="panel-body" ';"auto"!=t.height&&(i+='style="height:600px;overflow-y:auto;"'),i+='><ul class="nav nav-list sidenav" id="treeul" data="url:'+t.url+';">';var o=lx.tree.sub(a,t),s="</ul></div></div>";n=i+o+s}r.empty().append(n),lx.tree.init()}})},lx.tree.sub=function(e,t){var n="";if(e){var n='<li><a href="javascript:void(0);" data="id:'+e.id+";url:"+e.url+';"><span class="glyphicon glyphicon-minus"></span>';t.checkbox&&(n+='<input type="checkbox" class="treecheckbox" ',e.checked&&(n+="checked"),n+="/>"),n+=e.text,t.showurl&&(n+="("+e.url+")"),t.edit&&(n+='&nbsp;&nbsp;<span class="label label-primary bstreeadd">添加子菜单</span>&nbsp;&nbsp;<span class="label label-primary bstreeedit">修改</span>&nbsp;&nbsp;<span class="label label-danger  bstreedel">删除</span>'),n+="</a>";var r=e.children;if(r&&r.length>0){n+='<ul style="padding-left:20px;" id="treeid_'+e.id+'" class="nav collapse ',t.open&&(n+="in"),n+='">';for(var a=0;a<r.length;a++)n+=lx.tree.sub(r[a],t);n+="</ul>"}n+="</li>"}return n},lx.tree.init=function(){lx.on("#treeul .glyphicon-minus","click",function(){$(this).parent().next().length>0&&($("#treeid_"+$(this).parents("a").qdata().id).collapse("hide"),$(this).removeClass("glyphicon-minus").addClass("glyphicon-plus"))}),lx.on("#treeul .glyphicon-plus","click",function(){$(this).parent().next().length>0&&($("#treeid_"+$(this).parents("a").qdata().id).collapse("show"),$(this).removeClass("glyphicon-plus").addClass("glyphicon-minus"))}),lx.on("input.treecheckbox","change",function(){var e=$(this).prop("checked");$(this).parent().next().find("input.treecheckbox").each(function(){$(this).prop("checked",e)});var t=!0,n=$(this).parent().parent().parent();n.children().each(function(){var e=$(this).children().children("input").prop("checked");e||(t=!1)}),n.prev().children("input").prop("checked",t)}),lx.tree.url=$("#treeul").qdata().url,lx.tree.url&&(lx.on(".bstreeadd","click",lx.tree.addp),lx.on(".bstreedel","click",lx.tree.del),lx.on(".bstreeedit","click",lx.tree.editp))},lx.tree.addp=function(){lx.dialog({url:lx.tree.url+"/add/"+$(this).parent().qdata().id,title:"添加子菜单",okbtn:"保存"},lx.tree.add)},lx.tree.add=function(){var e;return lx.ajax({url:lx.tree.url+"/save",data:$("#bsmodal").find("form").qser(),async:!1},function(t){e=t}),lx.msg(e),!(!e||"success"!=e.type)&&(lx.crud.url=lx.tree.url,lx.crud.reset(),!0)},lx.tree.del=function(){lx.ajax({url:lx.tree.url+"/del/"+$(this).parent().qdata().id},function(e){lx.msg(e),e&&"success"==e.type&&(lx.crud.url=lx.tree.url,lx.crud.reset())})},lx.tree.editp=function(){lx.dialog({url:lx.tree.url+"/savep?id="+$(this).parent().qdata().id,title:"修改菜单",okbtn:"保存"},lx.tree.edit)},lx.tree.edit=function(){return lx.crud.url=lx.tree.url,lx.crud.save()},$.extend({dropguid:function(e){var t=new Date,n=dateFormat("Ymd",t),r=t.getTime().toString(32);return(e||"o_")+n+"_"+r}}),{paramString2obj:paramString2obj,backTip:backTip,dateFormat:dateFormat,jsonToStr:jsonToStr,strToJson:strToJson,sendFile:sendFile,summerNoteEditor:summerNoteEditor,dropZoneInit:dropZoneInit,fileInpputInit:fileInpputInit,dictDataInit:dictDataInit}});