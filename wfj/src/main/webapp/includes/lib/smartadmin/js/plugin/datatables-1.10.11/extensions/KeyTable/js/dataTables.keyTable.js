/*! KeyTable 2.1.1
 * Â©2009-2016 SpryMedia Ltd - datatables.net/license
 */

/**
 * @summary     KeyTable
 * @description Spreadsheet like keyboard navigation for DataTables
 * @version     2.1.1
 * @file        dataTables.keyTable.js
 * @author      SpryMedia Ltd (www.sprymedia.co.uk)
 * @contact     www.sprymedia.co.uk/contact
 * @copyright   Copyright 2009-2016 SpryMedia Ltd.
 *
 * This source file is free software, available under the following license:
 *   MIT license - http://datatables.net/license/mit
 *
 * This source file is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the license files for details.
 *
 * For details please refer to: http://www.datatables.net
 */

!function(e){"function"==typeof define&&define.amd?define(["jquery","datatables.net"],function(t){return e(t,window,document)}):"object"==typeof exports?module.exports=function(t,s){return t||(t=window),s&&s.fn.dataTable||(s=require("datatables.net")(t,s).$),e(s,t,t.document)}:e(jQuery,window,document)}(function(e,t,s,n){var i=e.fn.dataTable,a=function(t,s){if(!i.versionCheck||!i.versionCheck("1.10.8"))throw"KeyTable requires DataTables 1.10.8 or newer";this.c=e.extend(!0,{},i.defaults.keyTable,a.defaults,s),this.s={dt:new i.Api(t),enable:!0,focusDraw:!1},this.dom={};var n=this.s.dt.settings()[0],o=n.keytable;return o?o:(n.keytable=this,void this._constructor())};return e.extend(a.prototype,{blur:function(){this._blur()},enable:function(e){this.s.enable=e},focus:function(e,t){this._focus(this.s.dt.cell(e,t))},focused:function(e){var t=this.s.lastFocus;if(!t)return!1;var s=this.s.lastFocus.index();return e.row===s.row&&e.column===s.column},_constructor:function(){this._tabInput();var t=this,n=this.s.dt,i=e(n.table().node());"static"===i.css("position")&&i.css("position","relative"),e(n.table().body()).on("click.keyTable","th, td",function(){if(t.s.enable!==!1){var e=n.cell(this);e.any()&&t._focus(e)}}),e(s).on("keydown.keyTable",function(e){t._key(e)}),this.c.blurable&&e(s).on("click.keyTable",function(s){e(s.target).parents(".dataTables_filter").length&&t._blur(),e(s.target).parents().filter(n.table().container()).length||e(s.target).parents("div.DTE").length||t._blur()}),this.c.editor&&n.on("key.keyTable",function(e,s,n,i,a){t._editor(n,a)}),n.settings()[0].oFeatures.bStateSave&&n.on("stateSaveParams.keyTable",function(e,s,n){n.keyTable=t.s.lastFocus?t.s.lastFocus.index():null}),n.on("xhr.keyTable",function(e){if(!t.s.focusDraw){var s=t.s.lastFocus;s&&(t.s.lastFocus=null,n.one("draw",function(){t._focus(s)}))}}),n.on("destroy.keyTable",function(){n.off(".keyTable"),e(n.table().body()).off("click.keyTable","th, td"),e(s.body).off("keydown.keyTable").off("click.keyTable")});var a=n.state.loaded();a&&a.keyTable?n.one("init",function(){var e=n.cell(a.keyTable);e.any()&&e.focus()}):this.c.focus&&n.cell(this.c.focus).focus()},_blur:function(){if(this.s.enable&&this.s.lastFocus){var t=this.s.lastFocus;e(t.node()).removeClass(this.c.className),this.s.lastFocus=null,this._emitEvent("key-blur",[this.s.dt,t])}},_columns:function(){var e=this.s.dt,t=e.columns(this.c.columns).indexes(),s=[];return e.columns(":visible").every(function(e){t.indexOf(e)!==-1&&s.push(e)}),s},_editor:function(t,s){var n=this.s.dt,i=this.c.editor;s.stopPropagation(),i.inline(this.s.lastFocus.index());var a=e("div.DTE input, div.DTE textarea");a.length&&a[0].select(),n.keys.enable("navigation-only"),n.one("key-blur.editor",function(){i.displayed()&&i.submit()}),i.one("close",function(){n.keys.enable(!0),n.off("key-blur.editor")})},_emitEvent:function(t,s){this.s.dt.iterator("table",function(n,i){e(n.nTable).triggerHandler(t,s)})},_focus:function(n,i){var a=this,o=this.s.dt,l=o.page.info(),r=this.s.lastFocus;if(this.s.enable){if("number"!=typeof n){var c=n.index();i=c.column,n=o.rows({filter:"applied",order:"applied"}).indexes().indexOf(c.row),l.serverSide&&(n+=l.start)}if(l.length!==-1&&(n<l.start||n>=l.start+l.length))return this.s.focusDraw=!0,void o.one("draw",function(){a.s.focusDraw=!1,a._focus(n,i)}).page(Math.floor(n/l.length)).draw(!1);if(e.inArray(i,this._columns())!==-1){l.serverSide&&(n-=l.start);var u=o.cell(":eq("+n+")",i,{search:"applied"});if(r){if(r.node()===u.node())return;this._blur()}var f=e(u.node());f.addClass(this.c.className),this._scroll(e(t),e(s.body),f,"offset");var d=o.table().body().parentNode;if(d!==o.table().header().parentNode){var h=e(d.parentNode);this._scroll(h,h,f,"position")}this.s.lastFocus=u,this._emitEvent("key-focus",[this.s.dt,u]),o.state.save()}}},_key:function(t){if(this.s.enable&&!(0===t.keyCode||t.ctrlKey||t.metaKey||t.altKey)){var s=this.s.lastFocus;if(s){var n=this,i=this.s.dt;if(!this.c.keys||e.inArray(t.keyCode,this.c.keys)!==-1)switch(t.keyCode){case 9:this._shift(t,t.shiftKey?"left":"right",!0);break;case 27:this.s.blurable&&this.s.enable===!0&&this._blur();break;case 33:case 34:t.preventDefault();var a=i.cells({page:"current"}).nodes().indexOf(s.node());i.one("draw",function(){var e=i.cells({page:"current"}).nodes();n._focus(i.cell(a<e.length?e[a]:e[e.length-1]))}).page(33===t.keyCode?"previous":"next").draw(!1);break;case 35:case 36:t.preventDefault();var o=i.cells({page:"current"}).indexes();this._focus(i.cell(o[35===t.keyCode?o.length-1:0]));break;case 37:this._shift(t,"left");break;case 38:this._shift(t,"up");break;case 39:this._shift(t,"right");break;case 40:this._shift(t,"down");break;default:this.s.enable===!0&&this._emitEvent("key",[i,t.keyCode,this.s.lastFocus,t])}}}},_scroll:function(e,t,s,n){var i=s[n](),a=s.outerHeight(),o=s.outerWidth(),l=t.scrollTop(),r=t.scrollLeft(),c=e.height(),u=e.width();i.top<l&&t.scrollTop(i.top),i.left<r&&t.scrollLeft(i.left),i.top+a>l+c&&t.scrollTop(i.top+a-c),i.left+o>r+u&&t.scrollLeft(i.left+o-u)},_shift:function(t,s,n){var i=this.s.dt,a=i.page.info(),o=a.recordsDisplay,l=this.s.lastFocus,r=this._columns();if(l){var c=i.rows({filter:"applied",order:"applied"}).indexes().indexOf(l.index().row);a.serverSide&&(c+=a.start);var u=i.columns(r).indexes().indexOf(l.index().column),f=c,d=r[u];"right"===s?u>=r.length-1?(f++,d=r[0]):d=r[u+1]:"left"===s?0===u?(f--,d=r[r.length-1]):d=r[u-1]:"up"===s?f--:"down"===s&&f++,f>=0&&f<o&&e.inArray(d,r)!==-1?(t.preventDefault(),this._focus(f,d)):n&&this.c.blurable?this._blur():t.preventDefault()}},_tabInput:function(){var t=this,s=this.s.dt,n=null!==this.c.tabIndex?this.c.tabIndex:s.settings()[0].iTabIndex;if(n!=-1){var i=e('<div><input type="text" tabindex="'+n+'"/></div>').css({position:"absolute",height:1,width:0,overflow:"hidden"}).insertBefore(s.table().node());i.children().on("focus",function(){t._focus(s.cell(":eq(0)","0:visible",{page:"current"}))})}}}),a.defaults={blurable:!0,className:"focus",columns:"",editor:null,focus:null,keys:null,tabIndex:null},a.version="2.1.1",e.fn.dataTable.KeyTable=a,e.fn.DataTable.KeyTable=a,i.Api.register("cell.blur()",function(){return this.iterator("table",function(e){e.keytable&&e.keytable.blur()})}),i.Api.register("cell().focus()",function(){return this.iterator("cell",function(e,t,s){e.keytable&&e.keytable.focus(t,s)})}),i.Api.register("keys.disable()",function(){return this.iterator("table",function(e){e.keytable&&e.keytable.enable(!1)})}),i.Api.register("keys.enable()",function(e){return this.iterator("table",function(t){t.keytable&&t.keytable.enable(e===n||e)})}),i.ext.selector.cell.push(function(e,t,s){var i=t.focused,a=e.keytable,o=[];if(!a||i===n)return s;for(var l=0,r=s.length;l<r;l++)(i===!0&&a.focused(s[l])||i===!1&&!a.focused(s[l]))&&o.push(s[l]);return o}),e(s).on("preInit.dt.dtk",function(t,s,n){if("dt"===t.namespace){var o=s.oInit.keys,l=i.defaults.keys;if(o||l){var r=e.extend({},o,l);o!==!1&&new a(s,r)}}}),a});