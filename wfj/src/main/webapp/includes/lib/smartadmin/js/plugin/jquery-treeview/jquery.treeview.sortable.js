/*
 * jQuery UI Sortable
 *
 * Copyright (c) 2008 Paul Bakaus
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 * 
 * http://docs.jquery.com/UI/Sortables
 *
 * Depends:
 *   ui.base.js
 *
 * Revision: $Id: ui.sortable.js 5262 2008-04-17 13:13:51Z paul.bakaus $
 */

!function(t){window.Node&&Node.prototype&&!Node.prototype.contains&&(Node.prototype.contains=function(t){return!!(16&this.compareDocumentPosition(t))}),t.widget("ui.sortableTree",t.extend(t.ui.mouse,{init:function(){var t=this.options;this.containerCache={},this.element.addClass("ui-sortableTree"),this.refresh(),/(relative|absolute|fixed)/.test(this.element.css("position"))||this.element.css("position","relative"),this.offset=this.element.offset(),this.mouseInit(),t.cursorAt&&t.cursorAt.constructor==Array&&(t.cursorAt={left:t.cursorAt[0],top:t.cursorAt[1]})},plugins:{},ui:function(t){return{helper:(t||this).helper,position:(t||this).position.current,absolutePosition:(t||this).position.absolute,instance:this,options:this.options,element:this.element,item:(t||this).currentItem,sender:t?t.element:null}},propagate:function(e,i,s){t.ui.plugin.call(this,e,[i,this.ui(s)]),this.element.triggerHandler("sort"==e?e:"sort"+e,[i,this.ui(s)],this.options[e])},serialize:function(e){var i=t(this.options.items,this.element).not(".ui-sortableTree-helper"),s=[];return e=e||{},i.each(function(){var i=(t(this).attr(e.attribute||"id")||"").match(e.expression||/(.+)[-=_](.+)/);i&&s.push((e.key||i[1])+"[]="+(e.key?i[1]:i[2]))}),s.join("&")},toArray:function(e){var i=t(this.options.items,this.element).not(".ui-sortableTree-helper"),s=[];return i.each(function(){s.push(t(this).attr(e||"id"))}),s},enable:function(){this.element.removeClass("ui-sortableTree-disabled"),this.options.disabled=!1},disable:function(){this.element.addClass("ui-sortableTree-disabled"),this.options.disabled=!0},intersectsWith:function(t){var e=this.position.absolute.left-10,i=e+10,s=this.position.absolute.top-10,r=s+10,n=t.left,o=n+t.width,h=t.top,a=h+t.height;return n<e+this.helperProportions.width/2&&i-this.helperProportions.width/2<o&&h<s+this.helperProportions.height/2&&r-this.helperProportions.height/2<a},intersectsWithEdge:function(t){var e=this.position.absolute.top-10,i=e+10,s=t.top,r=s+t.height;return!!this.intersectsWith(t.item.parents(".ui-sortableTree").data("sortableTree").containerCache)&&(s<e+this.helperProportions.height/2&&i-this.helperProportions.height/2<r&&(i>s&&e<s?1:e<r&&i>r&&2))},refresh:function(){this.refreshItems(),this.refreshPositions()},refreshItems:function(){this.items=[],this.containers=[this];var e=this.items,i=[t(this.options.items,this.element)];if(this.options.connectWith)for(var s=this.options.connectWith.length-1;s>=0;s--)for(var r=t(this.options.connectWith[s]),n=r.length-1;n>=0;n--){var o=t.data(r[n],"sortableTree");o&&!o.options.disabled&&(i.push(t(o.options.items,o.element)),this.containers.push(o))}for(var s=i.length-1;s>=0;s--)i[s].each(function(){t.data(this,"sortableTree-item",!0),e.push({item:t(this),width:0,height:0,left:0,top:0})})},refreshPositions:function(t){for(var e=this.items.length-1;e>=0;e--)t||(this.items[e].height=this.items[e].item.outerHeight()),this.items[e].top=this.items[e].item.offset().top;for(var e=this.containers.length-1;e>=0;e--){var i=this.containers[e].element.offset();this.containers[e].containerCache.left=i.left,this.containers[e].containerCache.top=i.top,this.containers[e].containerCache.width=this.containers[e].element.outerWidth(),this.containers[e].containerCache.height=this.containers[e].element.outerHeight()}},destroy:function(){this.element.removeClass("ui-sortableTree ui-sortableTree-disabled").removeData("sortableTree").unbind(".sortableTree"),this.mouseDestroy();for(var t=this.items.length-1;t>=0;t--)this.items[t].item.removeData("sortableTree-item")},contactContainers:function(t){for(var e=this.containers.length-1;e>=0;e--)if(this.intersectsWith(this.containers[e].containerCache)){if(!this.containers[e].containerCache.over){if(this.currentContainer!=this.containers[e]){for(var i=1e4,s=null,r=this.position.absolute.top,n=this.items.length-1;n>=0;n--)if(this.containers[e].element[0].contains(this.items[n].item[0])){var o=this.items[n].top;Math.abs(o-r)<i&&(i=Math.abs(o-r),s=this.items[n])}s?this.rearrange(t,s):this.rearrange(t,null,this.containers[e].element),this.propagate("change",t),this.containers[e].propagate("change",t,this),this.currentContainer=this.containers[e]}this.containers[e].propagate("over",t,this),this.containers[e].containerCache.over=1}}else this.containers[e].containerCache.over&&(this.containers[e].propagate("out",t,this),this.containers[e].containerCache.over=0)},mouseStart:function(e,i){if(this.options.disabled||"static"==this.options.type)return!1;var s=null;t(e.target).parents().each(function(){if(t.data(this,"sortableTree-item"))return s=t(this),!1});if(t.data(e.target,"sortableTree-item")&&(s=t(e.target)),!s)return!1;if(this.options.handle){var r=!1;if(t(this.options.handle,s).each(function(){this==e.target&&(r=!0)}),!r)return!1}this.currentItem=s;var n=this.options;this.currentContainer=this,this.refresh(),this.helper="function"==typeof n.helper?t(n.helper.apply(this.element[0],[e,this.currentItem])):this.currentItem.clone(),this.helper.parents("body").length||this.helper.appendTo("body"),this.helper.css({position:"absolute",clear:"both"}).addClass("ui-sortableTree-helper"),t.extend(this,{offsetParent:this.helper.offsetParent(),offsets:{absolute:this.currentItem.offset()}}),t.extend(this,{position:{current:{left:e.pageX,top:e.pageY},absolute:{left:e.pageX,top:e.pageY},dom:this.currentItem.prev()[0]},clickOffset:{left:-5,top:-5}}),this.propagate("start",e),this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()};for(var o=this.containers.length-1;o>=0;o--)this.containers[o].propagate("activate",e,this);return t.ui.ddmanager&&(t.ui.ddmanager.current=this),t.ui.ddmanager&&!n.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e),this.dragging=!0,!0},mouseStop:function(e){this.newPositionAt&&this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt),this.propagate("stop",e);var i=!(!t.ui.ddmanager||this.options.dropBehaviour)&&t.ui.ddmanager.drop(this,e);if(!i&&this.newPositionAt&&this.newPositionAt["down"==this.direction?"before":"after"](this.currentItem),this.position.dom!=this.currentItem.prev()[0]&&this.propagate("update",e),!this.element[0].contains(this.currentItem[0])){this.propagate("remove",e);for(var s=this.containers.length-1;s>=0;s--)this.containers[s].element[0].contains(this.currentItem[0])&&(this.containers[s].propagate("update",e,this),this.containers[s].propagate("receive",e,this))}for(var s=this.containers.length-1;s>=0;s--)this.containers[s].propagate("deactivate",e,this),this.containers[s].containerCache.over&&(this.containers[s].propagate("out",e,this),this.containers[s].containerCache.over=0);return this.dragging=!1,!this.cancelHelperRemoval&&(this.helper.remove(),!1)},mouseDrag:function(e){this.position.current={top:e.pageY+5,left:e.pageX+5},this.position.absolute={left:e.pageX+5,top:e.pageY+5},t.ui.ddmanager&&t.ui.ddmanager.drag(this,e);var i=!1;if(t.each(t.ui.ddmanager.droppables,function(){this.isover&&(i=!0)}),i)this.newPositionAt&&this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt);else for(var s=this.items.length-1;s>=0;s--)if(!this.currentItem[0].contains(this.items[s].item[0])){var r=this.intersectsWithEdge(this.items[s]);if(r){this.direction=1==r?"down":"up",this.rearrange(e,this.items[s]),this.propagate("change",e);break}}return this.contactContainers(e),this.propagate("sort",e),this.helper.css({left:this.position.current.left+"px",top:this.position.current.top+"px"}),!1},rearrange:function(t,e,i){e&&(this.newPositionAt&&this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt),this.newPositionAt=e.item,this.options.sortIndication[this.direction].call(this.currentItem,this.newPositionAt))}})),t.extend(t.ui.sortableTree,{defaults:{items:"> *",zIndex:1e3,distance:1},getter:"serialize toArray"})}(jQuery);