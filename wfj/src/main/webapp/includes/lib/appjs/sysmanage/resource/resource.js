define(["DT","basetools"],function(e,t){var l,s=function(){$.app.pageSetUp(),runFunDataTables(),$("#resnavTab a").click(function(e){$("#resource_table input[type='checkbox']").prop("checked",!1),$("#saveres").attr("disabled",!0),$("#role_table tr,#user_table tr").removeClass("selectTr"),$(".ctd").hide(),$("#resource_table_wrapper tr th:nth-child(4),#resource_table_wrapper tr td:nth-child(4)/*,#resource_table_wrapper tr th:nth-child(5),#resource_table_wrapper tr td:nth-child(5)*/").hide()}),$("#role_table,#user_table").on("click","a",function(){$("#role_table tr,#user_table tr").removeClass("selectTr"),$(".ctd").show(),$("#resource_table_wrapper tr th:nth-child(4),#resource_table_wrapper tr td:nth-child(4)/*,#resource_table_wrapper tr th:nth-child(5),#resource_table_wrapper tr td:nth-child(5)*/").show(),$(this.parentNode.parentNode.parentNode).addClass("selectTr"),$("#resource_table input[type='checkbox']").prop("checked",!1),$("#saveres").removeAttr("disabled"),$("#resource_table  tbody tr[role='row']").each(function(){$(this).find(">td:eq(0)>i").removeClass("glyphicon glyphicon-plus-sign").addClass("glyphicon glyphicon-minus-sign"),l.fnOpen(this,fnFormatDetails(this,!0),"details")})}),$(document).on("click","#fall,#rall",function(){"fall"==$(this).attr("id")?$(this).prop("checked")?($(this).closest("tr").next().find("input[role='allowCk']").prop("checked",!0),$(this).closest("tr").next().find("input[role='readCk']").prop("checked",!1)):$(this).closest("tr").next().find("input[role='allowCk']").prop("checked",!1):"rall"==$(this).attr("id")&&($(this).prop("checked")?($(this).closest("tr").next().find("input[role='readCk']").prop("checked",!0),$(this).closest("tr").next().find("input[role='allowCk']").prop("checked",!1)):$(this).closest("tr").next().find("input[role='readCk']").prop("checked",!1))}),$(document).on("click","#resource_table input[type='checkbox']",function(){$(this.parentNode.parentNode.parentNode).siblings().find("input[type='checkbox']").prop("checked",!1)}),$("#resnavTab a:last").click(function(){$("#res2").show(),e.createTable("user",{url:$.apiPath+moduleName.user+$.apijoin+"employee"+$.apijoin+"page?agencyCode="+agencyCode+"&lockStatus=N&exSuper=Y",extra:{bLengthChange:!1,iDisplayLength:10,bSort:!1},unclickable:!0,aoColumns:[{sTitle:"sequenceNBR",mData:"sequenceNBR",sClass:"center",bVisible:!1},{sTitle:"工号",mData:"employeeCode",sWidth:"20%",sClass:"center"},{sTitle:"姓名",mData:"userName",sWidth:"30%",sClass:"left"},{sTitle:"岗位",mData:"roleName",sWidth:"30%",sClass:"left",render:function(e,t,l,s){return e&&e.length?e.join(","):"-"}},{sTitle:"操作",sDefaultContent:"",sWidth:"20%",sClass:"center"}],fnRowCallback:function(e,t,l,s){$("td:eq(3)",e).html('<b><a class="btn btn-primary" id="'+t.userId+'">分配资源</a></b>')}})})};return this.runFunDataTables=function(){l=e.createTable("resource",{url:$.apiPath+moduleName.resource+$.apijoin+"permissions",aaSorting:[1,"asc"],aoColumns:[{sTitle:"资源",sDefaultContent:"",sWidth:"10%",sClass:"center",bSortable:!1},{sTitle:"moduleCode",mData:"MODULE_CODE",bVisible:!1},{sTitle:"资源操作",mData:"MODULE_NAME",sWidth:"35%",sClass:"center",bSortable:!1},{sTitle:"resourceCode",mData:"RESOURCE_CODE",bVisible:!1},{sTitle:"resourceName",mData:"RESOURCE_NAME",bVisible:!1},{sTitle:"描述",sDefaultContent:"",sWidth:"35%",sClass:"center",bSortable:!1},{sTitle:"允许",sDefaultContent:"",sWidth:"10%",sClass:"center",bSortable:!1}],extra:{bPaginate:!1,bInfo:!1},unclickable:!0,subScrollHeight:55,toolbar:{buttons:[{btnId:"saveres",title:"保存",callback:function(){saveResource()}}]},fnRowCallback:function(e,t,s,a){$(e).html('<td class="left" colspan="3" style="background-color: #ecf3f8"></td><td class="ctd" style="background-color: #ecf3f8"><form class="smart-form"><label class="radio" style="margin-top: -5px;left:32%;width: 1px;"><input type="checkbox" id="fall"/><i></i></label></form></td></td>'),$("td:eq(0)",e).html('<i style="color:#004f86;font-weight: bold;" class="glyphicon glyphicon-minus-sign"  onclick="subTab(1,this)">    ('+t.MODULE_NAME+")-"+(""==t.RESOURCE_NAME?t.RESOURCE_CODE:t.RESOURCE_NAME)+"</i>"),l.fnOpen(e,fnFormatDetails(e,!0),"details")},initComplete:function(e,t){$(".ctd").hide(),$("#resource_table_wrapper tr th:nth-child(4),#resource_table_wrapper tr td:nth-child(4)/*,#resource_table_wrapper tr th:nth-child(5),#resource_table_wrapper tr td:nth-child(5)*/").hide()}}),e.createTable("role",{url:$.apiPath+moduleName.role+$.apijoin+"roles"+$.apijoin+"page?lockStatus=N",aaSorting:[[1,"desc"]],extra:{bLengthChange:!1,iDisplayLength:10},unclickable:!0,aoColumns:[{sTitle:"sequenceNBR",mData:"sequenceNBR",bVisible:!1},{sTitle:"工号",mData:"roleCode",bVisible:!1},{sTitle:"角色名称",mData:"roleName",sWidth:"50%",sClass:"left"},{sTitle:"操作",sDefaultContent:"",sWidth:"50%",sClass:"center",bSortable:!1}],fnRowCallback:function(e,t,l,s){$("td:eq(1)",e).html('<b><a class="btn btn-primary" id="'+t.roleCode+'">分配资源</a></b>')}})},this.subTab=function(e,t){$this=t;var s=$this.parentNode.parentNode;if(t.className.match("glyphicon-minus-sign"))t.className="glyphicon glyphicon-plus-sign",l.fnClose(s);else{t.className="glyphicon glyphicon-minus-sign";var a="none"!=$(s).find("td.ctd").css("display");l.fnOpen(s,fnFormatDetails(s,a),"details")}},this.fnFormatDetails=function(e,t){for(var s=t?"":"display:none",a=l.fnGetData(e),r=a.roList,o='<table  class="table table-striped table-bordered table-hover" >',i=r.length,n=0;n<i;n++)o+='<tr class="'+r[n].moduleCode+'"><td width="10%"><input type="hidden" role="moduleCode" value="'+r[n].moduleCode+'"/><input type="hidden" role="resourceCode" value="'+r[n].resourceCode+'"/></td>',o+='<td width="35%">'+r[n].oprateName+"</td>",o+='<td width="35%">'+r[n].funcId+"</td>",o+='<td width="10%" class="'+r[n].resourceCode+'" style="'+s+'"><form class="smart-form"><label class="radio" style="margin-top: -5px;left:32%;width: 1px;"><input type="checkbox" name="ck'+n+'" role="allowCk"  cid="'+r[n].funcId+'F" value="'+r[n].funcId+'"/><i></i></label></form></td>';return o+="</table>"},this.saveResource=function(){var e="",l="";$.each($("#resource_table input[role='allowCk']"),function(){$(this).prop("checked")&&(e+='{"funcId":"'+$(this).attr("value")+'","resourceCode":"'+$(this).closest("tr").find("input[role='resourceCode']").val()+'","moduleCode":"'+$(this).closest("tr").find("input[role='moduleCode']").val()+'"},')}),0!=e.length&&(e=e.substring(0,e.length-1)),$.each($("#resource_table input[role='readCk']"),function(){$(this).prop("checked")&&(l+='{"funcId":"'+$(this).attr("value")+'","resourceCode":"'+$(this).closest("tr").find("input[role='resourceCode']").val()+'","moduleCode":"'+$(this).closest("tr").find("input[role='moduleCode']").val()+'"},')}),0!=l.length&&(l=l.substring(0,l.length-1)),$.restAjax({url:$.apiPath+moduleName.resource+$.apijoin+"privileges",type:"post",dataType:"json",data:'{"pmType":"'+$("#resnavTab>li.active>a").attr("role").toUpperCase()+'","pmCode":"'+$(".selectTr a").attr("id")+'","privilegeF":['+e+'],"privilegeR":['+l+"]}",success:function(e){"200"==e.status?t.backTip(e,"Y"):t.backTip(e,"N")}})},{init:s}});